<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Water Health Index - Farmers</title>
  <style>
    :root{
      --sidebar-wide:225px;
      --sidebar-min:210px;
      --sidebar-max:380px;
      --accent:#51daf7;
      --active:#48e8c2;
      --card-bg:#1d334b;
      --shadow:0 8px 32px #17487d40;
    }
    html,body{
      margin:0;
      background:linear-gradient(120deg,rgba(81,218,247,0.74),rgba(23,72,125,0.81) 85%);
      background-size:cover;
      background-repeat:no-repeat;
      background-attachment:fixed;
      color:#e3fbfa;
      font-family:"Times New Roman",Times,serif;
      min-height:100vh;
      box-sizing:border-box;
    }
    body{position:relative;}
    .layout-wrap{display:flex;min-height:100vh;}

    /* Sidebar */
    .sidebar{
      width:var(--sidebar-wide);
      min-width:var(--sidebar-min);
      max-width:var(--sidebar-max);
      background:rgba(16,38,54,0.98);
      box-shadow:3px 0 20px #143d5344;
      position:fixed;
      left:0;top:0;bottom:0;
      display:flex;
      flex-direction:column;
      z-index:2000;
      overflow-y:auto;
    }
    .sidebar-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      margin:2.1rem 0 2.3rem 0;
    }
    .logo-img{
      font-size:2.7rem;
      animation:waveMotion 2.3s infinite alternate cubic-bezier(.55,.06,.87,.6);
      filter:drop-shadow(0 2px 19px #51daf7a0);
    }
    .logo-text{
      color:var(--accent);
      font-size:2.1rem;
      font-weight:bold;
      text-align:center;
      letter-spacing:.02em;
      line-height:1.16;
    }
    @keyframes waveMotion{
      0%{transform:translateY(0);}
      100%{transform:translateY(-8px);}
    }
    .sidebar nav{display:flex;flex-direction:column;gap:1.05rem;margin-bottom:auto;}
    .nav-link{
      color:#e3fbfa;
      text-decoration:none;
      padding:.7rem 1.15rem;
      font-size:1.09rem;
      display:flex;
      align-items:center;
      gap:.7rem;
      border-radius:13px;
      margin:0 .4rem;
      transition:background .12s,color .12s;
      font-weight:500;
    }
    .nav-link.active,.nav-link:hover{background:var(--active);color:#154b68;}
    .sidebar-footer{
      color:#9ee8ff;
      font-size:.95rem;
      font-style:italic;
      padding:1.1rem .8rem 1rem;
      text-align:center;
    }
    .sidebar-handle{
      position:absolute;
      top:0;right:0;
      width:6px;height:100%;
      cursor:ew-resize;
    }
    .sidebar-handle:hover{background:rgba(81,218,247,0.45);}

    /* Mobile top bar */
    .mobile-topbar{display:none;}
    @media(max-width:900px){
      .mobile-topbar{
        position:fixed;top:0;left:0;right:0;
        height:52px;
        background:rgba(10,30,46,0.98);
        display:flex;
        align-items:center;
        padding:0 .8rem;
        z-index:2100;
        box-shadow:0 2px 12px #00000055;
      }
      .mobile-menu-btn{
        width:34px;height:34px;
        border-radius:50%;
        border:1px solid #51daf7;
        background:#153044;
        color:#e3fbfa;
        font-size:1.2rem;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        margin-right:.7rem;
      }
      .mobile-topbar-title{
        color:#9ee8ff;
        font-weight:bold;
        font-size:1.05rem;
      }
      .sidebar{
        top:52px;bottom:0;
        width:220px;max-width:80vw;
        transform:translateX(-100%);
        transition:transform .22s ease-out;
      }
      .sidebar.open{transform:translateX(0);}
      .sidebar-header{margin:1rem 0;}
      .logo-img{font-size:2.1rem;}
      .logo-text{font-size:1.3rem;}
      .sidebar nav .nav-link{font-size:1rem;padding:.7rem .9rem;}
      .sidebar-handle{display:none;}
      .layout-wrap{margin-top:52px;}
    }

    /* Main */
    .main-wrap{
      margin-left:var(--sidebar-wide);
      padding:4vw 4vw 3vw;
      min-height:100vh;
      box-sizing:border-box;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:2rem;
      position:relative;
      z-index:1;
    }
    @media(max-width:900px){
      .main-wrap{margin-left:0;padding:4vw 2.2vw 3vw;}
    }

    /* Language pill */
    .lang-wrap{
      position:fixed;
      top:1.3rem;
      right:1.4rem;
      z-index:1500;
    }
    .lang-current{
      background:#51daf7;
      color:#173048;
      font-weight:bold;
      font-size:1.1rem;
      border:none;
      border-radius:20px;
      padding:.6rem 1.7rem .6rem 1rem;
      cursor:pointer;
      box-shadow:0 2px 12px #2183a235;
      display:flex;
      align-items:center;
      gap:.6rem;
    }
    .lang-dropdown{
      display:none;
      flex-direction:column;
      position:absolute;
      top:2.7rem;right:0;
      background:#184c6cfa;
      border-radius:14px;
      box-shadow:0 7px 26px #155070ad;
      padding:.4rem .55rem;
      border:1.4px solid #39bbe9;
      overflow-y:auto;
      max-height:50vh;
      min-width:170px;
      box-sizing:border-box;
    }
    .lang-dropdown.open{display:flex;}
    .lang-opt{
      background:transparent;
      color:#55ebca;
      border-radius:11px;
      border:1.2px solid #39bbe9;
      font-size:1rem;
      font-family:inherit;
      margin-bottom:.22rem;
      cursor:pointer;
      padding:.4rem .76rem;
      text-align:left;
      transition:background .12s,color .12s,border-color .12s;
      font-weight:600;
    }
    .lang-opt:hover,.lang-opt.selected{
      background:#51daf7;
      color:#143d53;
      border-color:#48e8c2;
    }
    @media(max-width:520px){
      .lang-current{font-size:1rem;padding:.5rem 1.3rem .5rem .8rem;}
    }

    /* Header row */
    .farmers-header-row{
      display:grid;
      grid-template-columns:minmax(270px,1.6fr) minmax(250px,1.1fr);
      gap:1.8rem;
      margin-top:4vw;
    }
    @media(max-width:900px){
      .farmers-header-row{grid-template-columns:1fr;}
    }
    .farmers-title-card{
      background:var(--card-bg);
      border-radius:24px;
      box-shadow:var(--shadow);
      border:1.2px solid #107dac;
      padding:1.7rem 2.1rem 1.6rem;
    }
    .farmers-heading{
      font-size:2rem;
      color:#55ebca;
      font-weight:bold;
      margin:0 0 .4rem;
      text-shadow:0 2px 16px #51daf784;
    }
    .farmers-intro{
      font-size:1.02rem;
      color:#d9fbff;
      margin:0 0 .9rem;
      line-height:1.6;
    }
    .farmers-badges{
      display:flex;
      flex-wrap:wrap;
      gap:.4rem;
      margin-bottom:.8rem;
    }
    .farmers-badge{
      padding:.16rem .6rem;
      border-radius:999px;
      font-size:.82rem;
      border:1px solid:#51daf7;
      color:#aefef5;
      background:rgba(8,30,46,0.9);
    }
    .farmers-ai-strip{
      display:flex;
      flex-wrap:wrap;
      gap:.7rem;
      align-items:center;
      justify-content:space-between;
      margin-top:.5rem;
    }
    .farmers-ai-note{
      font-size:.9rem;
      color:#bdefff;
      max-width:320px;
    }
    .farmers-ai-btn{
      font-weight:bold;
      font-size:1rem;
      padding:.6rem 1.4rem;
      border-radius:999px;
      border:1.4px solid #51daf7;
      background:#48e8c2;
      color:#173048;
      cursor:pointer;
      box-shadow:0 2px 15px #48e8c231;
      transition:background .15s,color .15s,transform .12s;
    }
    .farmers-ai-btn:hover{background:#17487d;color:#b7fff6;transform:translateY(-1px);}

    .farmers-status-card{
      background:radial-gradient(circle at 10% -10%,rgba(132,255,247,0.35),rgba(14,34,52,0.95));
      border-radius:22px;
      padding:1.2rem 1.5rem 1.4rem;
      border:1.4px solid #4dd7ff;
      box-shadow:0 10px 30px #02070fa8;
      position:relative;
      overflow:hidden;
    }
    .farmers-status-card::before{
      content:"";
      position:absolute;
      inset:-60%;
      background:
        radial-gradient(circle at 20% 120%,rgba(81,218,247,0.25),transparent 55%),
        radial-gradient(circle at 90% -10%,rgba(184,255,248,0.2),transparent 50%);
      opacity:0.4;
      pointer-events:none;
    }
    .farmers-status-title{
      position:relative;
      font-size:1.2rem;
      margin-bottom:.25rem;
      color:#f3fffd;
    }
    .farmers-status-text{
      position:relative;
      font-size:.9rem;
      color:#c7f3ff;
      margin-bottom:.6rem;
    }
    .farmers-status-pill{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.22rem .8rem;
      border-radius:999px;
      font-size:.86rem;
      font-weight:bold;
      background:#163947;
      border:1px solid #48e8c2;
      color:#bffef3;
    }
    .status-chip{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:.8rem;
      font-weight:bold;
      margin-left:.1rem;
    }
    .chip-ok{background:#225f36;color:#e7ffe9;}
    .chip-warn{background:#735616;color:#fff2c0;}
    .chip-bad{background:#7b1f1f;color:#ffe3e3;}
    .farmers-status-small{
      position:relative;
      display:block;
      font-size:.78rem;
      color:#e0fbff;
      margin-top:.45rem;
      opacity:.9;
    }

    /* Main grid */
    .farmers-main-grid{
      display:grid;
      grid-template-columns:minmax(280px,1.6fr) minmax(260px,1.2fr);
      gap:1.6rem;
    }
    @media(max-width:900px){
      .farmers-main-grid{grid-template-columns:1fr;}
    }
    .farmers-panel{
      background:rgba(17,40,60,0.96);
      border-radius:22px;
      border:1.1px solid #1fa8d7;
      padding:1.4rem 1.6rem 1.6rem;
      box-shadow:0 7px 24px rgba(0,0,0,0.55);
    }
    .farmers-panel h2{
      margin:0 0 .4rem;
      font-size:1.35rem;
      color:#55ebca;
    }
    .farmers-panel-sub{
      font-size:.9rem;
      color:#aee3ff;
      margin-bottom:.8rem;
    }
    .farmers-section{
      margin-top:1rem;
      padding-top:.6rem;
      border-top:1px solid rgba(160,220,240,0.28);
    }
    .farmers-section-title{
      font-weight:bold;
      color:#51daf7;
      margin-bottom:.35rem;
      font-size:.95rem;
    }

    .controls-row{
      display:flex;
      flex-wrap:wrap;
      gap:.6rem;
      align-items:center;
      margin:.4rem 0 .7rem;
    }
    .controls-row label{
      font-weight:bold;
      color:#9ee8ff;
      font-size:.9rem;
    }
    .controls-row input[type=number],
    .controls-row select{
      padding:.4rem .6rem;
      border-radius:7px;
      border:1px solid #27536b;
      background:#182b35;
      color:#e7fbff;
      font-family:"Times New Roman",Times,serif;
      font-size:.95rem;
    }
    .controls-row select{min-width:190px;}

    .btn-main{
      border:none;
      border-radius:8px;
      padding:.45rem .95rem;
      font-family:"Times New Roman",Times,serif;
      font-size:.95rem;
      font-weight:bold;
      cursor:pointer;
      background:#2cb5d6;
      color:#fff;
      transition:background .15s,transform .08s;
    }
    .btn-main:hover{background:#168eaf;transform:translateY(-1px);}
    .btn-ghost{
      border-radius:8px;
      padding:.45rem .95rem;
      font-family:"Times New Roman",Times,serif;
      font-size:.95rem;
      font-weight:bold;
      cursor:pointer;
      background:transparent;
      border:1px solid #3b7b95;
      color:#cdefff;
      transition:background .15s,color .15s,transform .08s;
    }
    .btn-ghost:hover{background:#153045;color:#ffffff;transform:translateY(-1px);}

    .note{
      font-size:.86rem;
      color:#b9e3ff;
      margin-top:.3rem;
    }

    .pill-list{
      display:flex;
      flex-wrap:wrap;
      gap:.35rem;
      margin-top:.3rem;
    }
    .pill{
      padding:3px 8px;
      border-radius:999px;
      font-size:.82rem;
      background:#16323f;
      border:1px solid #3f7f97;
      color:#d2f6ff;
    }

    .advice-card{
      background:#162c3a;
      border-radius:10px;
      padding:.6rem .7rem .7rem;
      font-size:.9rem;
      color:#e5fbff;
      margin-top:.3rem;
    }
    .advice-title{
      font-weight:bold;
      color:#55ebca;
      margin-bottom:.18rem;
    }
    .advice-card ul{
      margin:.2rem 0 0 1.1rem;
      padding:0;
      list-style:disc;
      font-size:.88rem;
    }

    /* AI placeholder */
    .ai-placeholder{
      position:fixed;
      bottom:32px;
      right:20px;
      width:340px;
      max-width:100%;
      background:#102530;
      border-radius:16px;
      border:1px solid #3fd1c9;
      box-shadow:0 0 18px #000;
      color:#e3fbfa;
      font-family:"Times New Roman",Times,serif;
      z-index:2400;
      display:none;
      overflow:hidden;
    }
    .ai-placeholder-header{
      padding:6px 10px;
      background:#143545;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .ai-placeholder-title{
      font-weight:bold;
      color:#55ebca;
      font-size:.96rem;
    }
    .ai-placeholder-close{
      border:1px solid #3b7b95;
      background:transparent;
      border-radius:7px;
      padding:2px 8px;
      color:#cdefff;
      cursor:pointer;
      font-size:.8rem;
    }
    .ai-placeholder-body{
      padding:9px 11px 11px;
      font-size:.88rem;
    }
  </style>
</head>
<body>

  <!-- Mobile top bar -->
  <header class="mobile-topbar">
    <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
    <div class="mobile-topbar-title" data-i18n="topbar_title">Water Index</div>
  </header>

  <div class="layout-wrap">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="logo-img" aria-hidden="true">üåä</span>
        <span class="logo-text">Water<br>Index</span>
      </div>
      <nav>
        <a href="index.html" class="nav-link">
          <span aria-hidden="true">üè†</span>
          <span class="label" data-i18n="nav_home">Home</span>
        </a>
        <a href="measure.html" class="nav-link">
          <span aria-hidden="true">üß™</span>
          <span class="label" data-i18n="nav_measure">Measure</span>
        </a>
        <a href="map.html" class="nav-link">
          <span aria-hidden="true">üó∫Ô∏è</span>
          <span class="label" data-i18n="nav_map">Map</span>
        </a>
        <a href="care.html" class="nav-link">
          <span aria-hidden="true">üíß</span>
          <span class="label" data-i18n="nav_care">Care</span>
        </a>
        <a href="farmers.html" class="nav-link active">
          <span aria-hidden="true">üåæ</span>
          <span class="label" data-i18n="nav_farmers">Farmers Assistant</span>
        </a>
        <a href="chart.html" class="nav-link">
          <span aria-hidden="true">üìä</span>
          <span class="label" data-i18n="nav_chart">Chart</span>
        </a>
        <a href="learn.html" class="nav-link">
          <span aria-hidden="true">üìö</span>
          <span class="label" data-i18n="nav_learn">Learn</span>
        </a>
        <a href="buykit.html" class="nav-link">
          <span aria-hidden="true">üõí</span>
          <span class="label" data-i18n="nav_buykit">Buy Kit</span>
        </a>
        <a href="about.html" class="nav-link">
          <span aria-hidden="true">‚ÑπÔ∏è</span>
          <span class="label" data-i18n="nav_about">About</span>
        </a>
      </nav>
      <footer class="sidebar-footer">
        &copy; 2025 Water Health Index ¬∑ Regional project
      </footer>
      <div class="sidebar-handle" id="sidebarHandle"></div>
    </aside>

    <!-- Main content -->
    <main class="main-wrap" id="mainWrap">

      <!-- Language pill -->
      <div class="lang-wrap">
        <button class="lang-current" id="langCurrentBtn">
          English <span style="font-size:1rem;">&#x25BC;</span>
        </button>
        <div class="lang-dropdown" id="langDropdown">
          <button class="lang-opt" data-lang="en">English</button>
          <button class="lang-opt" data-lang="hi">Hindi</button>
          <button class="lang-opt" data-lang="bn">Bengali</button>
          <button class="lang-opt" data-lang="ta">Tamil</button>
          <button class="lang-opt" data-lang="mr">Marathi</button>
          <button class="lang-opt" data-lang="gu">Gujarati</button>
          <button class="lang-opt" data-lang="pa">Punjabi</button>
          <button class="lang-opt" data-lang="te">Telugu</button>
          <button class="lang-opt" data-lang="kn">Kannada</button>
          <button class="lang-opt" data-lang="ur">Urdu</button>
        </div>
      </div>

      <!-- Top row -->
      <section class="farmers-header-row">
        <article class="farmers-title-card">
          <h1 class="farmers-heading" data-i18n="farm_title">Farmers Assistance</h1>
          <p class="farmers-intro" data-i18n="farm_intro">
            Turn water readings into simple steps: choose pH, pick a crop, and read
            clear tips on what to do next.
          </p>
          <div class="farmers-badges">
            <span class="farmers-badge" data-i18n="farm_badge_household">Households</span>
            <span class="farmers-badge" data-i18n="farm_badge_farmers">Farmers</span>
            <span class="farmers-badge" data-i18n="farm_badge_students">Student projects</span>
          </div>
          <div class="farmers-ai-strip">
            <p class="farmers-ai-note" data-i18n="farm_ai_note">
              In the next version this button will open a full voice helper. For now it shows a simple preview box.
            </p>
            <button class="farmers-ai-btn" id="openFarmAiBtn" data-i18n="farm_ai_btn">
              Open Farmers AI Assistant
            </button>
          </div>
        </article>

        <article class="farmers-status-card">
          <h2 class="farmers-status-title" data-i18n="status_title">Latest water status</h2>
          <p class="farmers-status-text" id="statusSummaryText" data-i18n="status_text_empty">
            No saved reading found yet. Measure water on the ‚ÄúMeasure‚Äù page and save it to see a quick summary here.
          </p>
          <div class="farmers-status-pill" id="statusPill" style="display:none;">
            <span id="statusPillLabel">pH ‚Äî</span>
            <span id="statusPillChip" class="status-chip chip-warn">‚Äì</span>
          </div>
          <span class="farmers-status-small" id="statusExtra"></span>
        </article>
      </section>

      <!-- Main grid -->
      <section class="farmers-main-grid">
        <!-- LEFT: pH helper -->
        <article class="farmers-panel">
          <h2 data-i18n="ph_helper_title">Smart pH helper</h2>
          <p class="farmers-panel-sub" data-i18n="ph_helper_sub">
            Step 1: choose a pH value. Step 2: see which crops are happy. Step 3: get
            clear actions to move pH closer to 7.0.
          </p>

          <div class="farmers-section">
            <div class="farmers-section-title" data-i18n="ph_choose_title">1. Choose or enter pH</div>
            <div class="controls-row">
              <label for="phInput" data-i18n="ph_label">pH</label>
              <input id="phInput" type="number" step="0.01" min="0" max="14" placeholder="7.00">
              <button class="btn-ghost" id="btnUseLatest" data-i18n="ph_use_latest">Use latest reading</button>
              <button class="btn-main" id="btnCheckPh" data-i18n="ph_check_btn">Check pH for crops</button>
            </div>
            <p class="note" data-i18n="ph_note">
              If you already measured water and pressed ‚ÄúSave‚Äù on the Measure page, this button will pull that value.
            </p>
            <div id="phStatusBox" class="note"></div>
            <div id="bestCropsBox" style="display:none;margin-top:.6rem;">
              <div class="advice-card">
                <div class="advice-title" data-i18n="best_crops_title">Best crops at this pH</div>
                <div id="bestCropsPills" class="pill-list"></div>
                <p class="note" id="bestCropsNote"></p>
              </div>
            </div>
          </div>

          <div class="farmers-section">
            <div class="farmers-section-title" data-i18n="ph_improve_title">2. Improve pH towards 7.0</div>
            <div class="controls-row">
              <label for="phImprove" data-i18n="ph_improve_label">Current pH</label>
              <input id="phImprove" type="number" step="0.01" min="0" max="14" placeholder="6.20">
              <button class="btn-main" id="btnImprove" data-i18n="ph_improve_btn">Show improvement tips</button>
            </div>
            <div id="improveCards" style="display:none;margin-top:.4rem;">
              <div class="advice-card">
                <div class="advice-title" data-i18n="short_term_title">Short‚Äëterm steps</div>
                <ul id="shortTermList"></ul>
              </div>
              <div class="advice-card">
                <div class="advice-title" data-i18n="long_term_title">Long‚Äëterm soil health</div>
                <ul id="longTermList"></ul>
              </div>
              <p class="note" data-i18n="improve_note">
                Always match pH correction with soil tests and local agriculture advice.
              </p>
            </div>
          </div>
        </article>

        <!-- RIGHT: crop advice -->
        <article class="farmers-panel">
          <h2 data-i18n="crop_helper_title">Crop‚Äëbased advice</h2>
          <p class="farmers-panel-sub" data-i18n="crop_helper_sub">
            Pick a crop and reuse the same pH. You will see simple text on fit, fertiliser,
            irrigation and care.
          </p>

          <div class="farmers-section">
            <div class="farmers-section-title" data-i18n="crop_choose_title">3. Select a crop</div>
            <div class="controls-row">
              <label for="cropSelect" data-i18n="crop_label">Crop</label>
              <select id="cropSelect">
                <option value="" data-i18n="crop_placeholder">Choose crop‚Ä¶</option>
              </select>
            </div>
            <p class="note" data-i18n="crop_note">
              Enter or load pH on the left, then choose crop here to see how well the water matches.
            </p>
          </div>

          <div class="farmers-section" id="cropAdviceArea" style="display:none;">
            <div class="advice-card">
              <div class="advice-title" data-i18n="crop_range_title">Ideal pH range</div>
              <div id="cropRangeText"></div>
            </div>
            <div class="advice-card">
              <div class="advice-title" data-i18n="crop_ph_improve_title">pH improvement for this crop</div>
              <ul id="cropImproveList"></ul>
            </div>
            <div class="advice-card">
              <div class="advice-title" data-i18n="irrigation_title">Irrigation tips</div>
              <ul id="irrigationList"></ul>
            </div>
            <div class="advice-card">
              <div class="advice-title" data-i18n="management_title">Fertiliser & management</div>
              <ul id="managementList"></ul>
            </div>
          </div>
        </article>
      </section>
    </main>
  </div>

  <!-- AI placeholder box -->
  <section class="ai-placeholder" id="aiPlaceholder">
    <header class="ai-placeholder-header">
      <div class="ai-placeholder-title" data-i18n="ai_placeholder_title">
        Farmers AI Assistant (preview)
      </div>
      <button class="ai-placeholder-close" id="aiPlaceholderClose" data-i18n="ai_placeholder_close">
        Close
      </button>
    </header>
    <div class="ai-placeholder-body">
      <p data-i18n="ai_placeholder_text">
        In the future this box will speak, answer questions and show step‚Äëby‚Äëstep guidance.
        For now it is only a preview. Use the pH helper and crop advice panels below.
      </p>
    </div>
  </section>

  <script>
    /* ========= SIMPLE TRANSLATIONS: EN ONLY FOR NOW ========= */
    function getFarmersStrings(langCode){
      const en={
        topbar_title:"Water Index",
        nav_home:"Home",
        nav_measure:"Measure",
        nav_map:"Map",
        nav_care:"Care",
        nav_farmers:"Farmers Assistant",
        nav_chart:"Chart",
        nav_learn:"Learn",
        nav_buykit:"Buy Kit",
        nav_about:"About",
        farm_title:"Farmers Assistance",
        farm_intro:"Turn water readings into simple steps: choose pH, pick a crop, and read clear tips on what to do next.",
        farm_badge_household:"Households",
        farm_badge_farmers:"Farmers",
        farm_badge_students:"Student projects",
        farm_ai_note:"In the next version this button will open a full voice helper. For now it shows a simple preview box.",
        farm_ai_btn:"Open Farmers AI Assistant",
        status_title:"Latest water status",
        status_text_empty:"No saved reading found yet. Measure water on the ‚ÄúMeasure‚Äù page and save it to see a quick summary here.",
        ph_helper_title:"Smart pH helper",
        ph_helper_sub:"Step 1: choose a pH value. Step 2: see which crops are happy. Step 3: get clear actions to move pH closer to 7.0.",
        ph_choose_title:"1. Choose or enter pH",
        ph_label:"pH",
        ph_use_latest:"Use latest reading",
        ph_check_btn:"Check pH for crops",
        ph_note:"If you already measured water and pressed ‚ÄúSave‚Äù on the Measure page, this button will pull that value.",
        best_crops_title:"Best crops at this pH",
        ph_improve_title:"2. Improve pH towards 7.0",
        ph_improve_label:"Current pH",
        ph_improve_btn:"Show improvement tips",
        short_term_title:"Short‚Äëterm steps",
        long_term_title:"Long‚Äëterm soil health",
        improve_note:"Always match pH correction with soil tests and local agriculture advice.",
        crop_helper_title:"Crop‚Äëbased advice",
        crop_helper_sub:"Pick a crop and reuse the same pH. You will see simple text on fit, fertiliser, irrigation and care.",
        crop_choose_title:"3. Select a crop",
        crop_label:"Crop",
        crop_placeholder:"Choose crop‚Ä¶",
        crop_note:"Enter or load pH on the left, then choose crop here to see how well the water matches.",
        crop_range_title:"Ideal pH range",
        crop_ph_improve_title:"pH improvement for this crop",
        irrigation_title:"Irrigation tips",
        management_title:"Fertiliser & management",
        ai_placeholder_title:"Farmers AI Assistant (preview)",
        ai_placeholder_close:"Close",
        ai_placeholder_text:"In the future this box will speak, answer questions and show step‚Äëby‚Äëstep guidance. For now it is only a preview. Use the pH helper and crop advice panels below."
      };
      return en; // other languages can be added later
    }

    const langBtn=document.getElementById('langCurrentBtn');
    const langDropdown=document.getElementById('langDropdown');
    const langOptions=document.querySelectorAll('.lang-opt');
    const i18nNodes=document.querySelectorAll('[data-i18n]');

    function applyFarmersLanguage(langCode){
      const t=getFarmersStrings(langCode);
      i18nNodes.forEach(el=>{
        const key=el.dataset.i18n;
        if(t[key]) el.textContent=t[key];
      });
    }
    (function initLanguage(){
      const saved=localStorage.getItem('whi_lang')||'en';
      applyFarmersLanguage(saved);
      langOptions.forEach(b=>{if(b.dataset.lang===saved)b.classList.add('selected');});
      const currentLabel=Array.from(langOptions).find(b=>b.dataset.lang===saved);
      if(currentLabel){
        langBtn.innerHTML=currentLabel.textContent+' <span style="font-size:1rem;">&#x25BC;</span>';
      }
    })();
    langBtn.addEventListener('click',e=>{
      e.stopPropagation();
      langDropdown.classList.toggle('open');
    });
    document.addEventListener('click',e=>{
      if(!langBtn.contains(e.target) && !langDropdown.contains(e.target)){
        langDropdown.classList.remove('open');
      }
    });
    langOptions.forEach(btn=>{
      btn.addEventListener('click',function(){
        langOptions.forEach(b=>b.classList.remove('selected'));
        this.classList.add('selected');
        const code=this.dataset.lang||'en';
        localStorage.setItem('whi_lang',code);
        langBtn.innerHTML=this.textContent+' <span style="font-size:1rem;">&#x25BC;</span>';
        langDropdown.classList.remove('open');
        applyFarmersLanguage(code);
      });
    });

    /* ========= SIDEBAR + MOBILE ========= */
    (function(){
      const sidebar=document.getElementById('sidebar');
      const mainWrap=document.getElementById('mainWrap');
      const handle=document.getElementById('sidebarHandle');
      if(!sidebar||!handle||!mainWrap)return;
      let isDragging=false,startX=0,startWidth=0;
      const rootStyles=getComputedStyle(document.documentElement);
      const minWidth=parseInt(rootStyles.getPropertyValue('--sidebar-min'))||210;
      const maxWidth=parseInt(rootStyles.getPropertyValue('--sidebar-max'))||380;
      handle.addEventListener('mousedown',e=>{
        if(window.innerWidth<=900)return;
        isDragging=true;startX=e.clientX;startWidth=sidebar.offsetWidth;
        document.body.style.userSelect='none';
      });
      window.addEventListener('mousemove',e=>{
        if(!isDragging)return;
        const delta=e.clientX-startX;
        let newWidth=startWidth+delta;
        if(newWidth<minWidth)newWidth=minWidth;
        if(newWidth>maxWidth)newWidth=maxWidth;
        sidebar.style.width=newWidth+'px';
        mainWrap.style.marginLeft=newWidth+'px';
      });
      window.addEventListener('mouseup',()=>{
        if(!isDragging)return;
        isDragging=false;
        document.body.style.userSelect='';
      });
      window.addEventListener('resize',()=>{
        if(window.innerWidth<=900){
          sidebar.style.width='';
          mainWrap.style.marginLeft='';
        }
      });
    })();

    (function(){
      const btn=document.getElementById('mobileMenuBtn');
      const sidebar=document.getElementById('sidebar');
      if(!btn||!sidebar)return;
      btn.addEventListener('click',e=>{
        e.stopPropagation();
        sidebar.classList.toggle('open');
      });
      document.addEventListener('click',e=>{
        if(window.innerWidth>900)return;
        if(!sidebar.classList.contains('open'))return;
        if(!sidebar.contains(e.target)&&e.target!==btn){
          sidebar.classList.remove('open');
        }
      });
    })();

    /* ========= AI PLACEHOLDER ========= */
    (function(){
      const openBtn=document.getElementById('openFarmAiBtn');
      const panel=document.getElementById('aiPlaceholder');
      const closeBtn=document.getElementById('aiPlaceholderClose');
      if(!openBtn||!panel||!closeBtn)return;
      openBtn.addEventListener('click',()=>{panel.style.display='block';});
      closeBtn.addEventListener('click',()=>{panel.style.display='none';});
    })();

    /* ========= STORAGE: LATEST READING (whReadings) ========= */
    const STORAGE_KEY='whReadings';  // same key as old page [file:13]

    function loadLatestReading(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY);
        if(!raw)return null;
        const arr=JSON.parse(raw);
        if(!Array.isArray(arr)||!arr.length)return null;
        const last=arr[arr.length-1];
        const p=typeof last.ph==="number"?last.ph:parseFloat(last.ph);
        if(isNaN(p))return null;
        return {ph:p,raw:last};
      }catch(e){return null;}
    }

    const statusSummaryText=document.getElementById('statusSummaryText');
    const statusPill=document.getElementById('statusPill');
    const statusPillLabel=document.getElementById('statusPillLabel');
    const statusPillChip=document.getElementById('statusPillChip');
    const statusExtra=document.getElementById('statusExtra');

    function classifyPH(p){
      if(isNaN(p))return{band:'unknown',label:'‚Äî',className:'chip-warn'};
      if(p<5)return{band:'veryLow',label:'strongly acidic',className:'chip-bad'};
      if(p<6)return{band:'low',label:'acidic',className:'chip-bad'};
      if(p<6.5)return{band:'slightLow',label:'slightly acidic',className:'chip-warn'};
      if(p<=7.5)return{band:'neutral',label:'near neutral',className:'chip-ok'};
      if(p<=8.2)return{band:'slightHigh',label:'slightly alkaline',className:'chip-warn'};
      if(p<=9)return{band:'high',label:'alkaline',className:'chip-bad'};
      return{band:'veryHigh',label:'very alkaline',className:'chip-bad'};
    }

    function updateLatestStatusBox(){
      const r=loadLatestReading();
      if(!r){
        statusPill.style.display='none';
        statusExtra.textContent='';
        return;
      }
      const p=r.ph;
      const c=classifyPH(p);
      statusPill.style.display='inline-flex';
      statusPillLabel.textContent='pH '+p.toFixed(2);
      statusPillChip.textContent=c.label;
      statusPillChip.className='status-chip '+c.className;
      statusSummaryText.textContent='Latest saved water has pH '+p.toFixed(2)+', which is '+c.label+' for most crops.';
      statusExtra.textContent='Tip: use the pH helper below to see matching crops and correction steps.';
    }

    /* ========= CROP DATABASE (21 CROPS) ========= */
    const FARM_CROPS=[
      {id:'rice',name:'Rice (paddy)',group:'staple',phMin:5.5,phMax:7.0,
        improveLow:[
          'If pH is below 5.5, mix farmyard manure and compost into the top soil.',
          'Apply agricultural lime or dolomite 2‚Äì3 months before transplanting as per soil test.'
        ],
        improveHigh:[
          'If pH is above 7.5, avoid long standing water and use short wet‚Äìdry cycles.',
          'Add green manure crops like dhaincha or sunnhemp and plough them in.'
        ],
        irrigation:[
          'Keep 3‚Äì5 cm water during tillering; drain field before harvest.',
          'Level the field so water depth is even in all corners.'
        ],
        fertiliser:[
          'Use split nitrogen in 2‚Äì3 doses instead of one heavy dose.',
          'Use basal NPK and add zinc sulphate where deficiency is common.'
        ]
      },
      {id:'wheat',name:'Wheat',group:'staple',phMin:6.0,phMax:7.5,
        improveLow:[
          'If pH is below 6.0, apply lime once in rotation based on soil test.',
          'Use more organic manure so soil does not become too sharp and acidic.'
        ],
        improveHigh:[
          'Above pH 7.8, watch for yellow leaves between veins; use zinc or iron foliar spray.',
          'Avoid over‚Äëirrigation that brings salts to the surface.'
        ],
        irrigation:[
          'Give irrigation at crown root initiation, tillering and grain filling.',
          'Do not allow waterlogging; wheat likes moist but airy soil.'
        ],
        fertiliser:[
          'Use balanced NPK as per local dose.',
          'Avoid only nitrogen; extra N makes crop tall and weak.'
        ]
      },
      {id:'maize',name:'Maize (corn)',group:'cereal',phMin:6.0,phMax:7.5,
        improveLow:[
          'Below pH 5.8, use lime so roots are not damaged by acidity.',
          'Mix lime with FYM for better and longer effect.'
        ],
        improveHigh:[
          'At high pH, use zinc and manganese rich fertiliser or foliar spray.',
          'Add crop residues back to the field every season.'
        ],
        irrigation:[
          'Do not allow stress at tasselling and grain filling; yield drops a lot.',
          'Avoid standing water for more than 1‚Äì2 days.'
        ],
        fertiliser:[
          'Place fertiliser in bands 5 cm away from seed, not broadcast.',
          'Use a starter dose of DAP or complex NPK at sowing.'
        ]
      },
      {id:'sugarcane',name:'Sugarcane',group:'cash',phMin:5.5,phMax:8.0,
        improveLow:[
          'Add lime and bulky organic manure to extend ratoon life.',
          'Use press‚Äëmud or filter cake where available.'
        ],
        improveHigh:[
          'Leach salts with good quality water if soil is alkaline and saline.',
          'Grow green manure crops in off‚Äëseason to soften soil.'
        ],
        irrigation:[
          'Give light but frequent irrigation in sandy soil.',
          'Stop irrigation 15‚Äì20 days before harvest.'
        ],
        fertiliser:[
          'Apply nitrogen in 3‚Äì4 splits along the furrow, not on the shoot.',
          'Use recommended doses of phosphorus and potash for strong canes.'
        ]
      },
      {id:'cotton',name:'Cotton',group:'cash',phMin:5.8,phMax:7.5,
        improveLow:[
          'Apply lime where soil is very acidic to avoid poor root growth.',
          'Mix FYM and compost at land preparation.'
        ],
        improveHigh:[
          'On sodic soils, use gypsum after soil test.',
          'Avoid irrigation with very salty or alkaline water.'
        ],
        irrigation:[
          'Give deep irrigation at flowering and boll formation.',
          'Avoid waterlogging; it causes boll drop and root rot.'
        ],
        fertiliser:[
          'Use balanced NPK and one dose of sulphur if soil is low in sulphur.',
          'Do not give heavy nitrogen after flowering; it delays maturity.'
        ]
      },
      {id:'soybean',name:'Soybean',group:'pulse',phMin:6.0,phMax:7.5,
        improveLow:[
          'Below pH 6.0, light liming improves nodulation.',
          'Use FYM and compost so soil stays loose.'
        ],
        improveHigh:[
          'At high pH, use iron or micronutrient spray if leaves turn yellow.',
          'Avoid thick waterlogging around plants.'
        ],
        irrigation:[
          'Protect crop from waterlogging in heavy rain.',
          'If irrigated, keep good moisture at flowering and pod filling.'
        ],
        fertiliser:[
          'Use seed treatment with Rhizobium and phosphate solubilising bacteria.',
          'Use starter phosphorus through DAP or SSP at sowing.'
        ]
      },
      {id:'groundnut',name:'Groundnut (peanut)',group:'oilseed',phMin:6.0,phMax:7.5,
        improveLow:[
          'Very acidic soil needs lime to support peg and pod formation.',
          'Apply gypsum at pegging for better kernel filling.'
        ],
        improveHigh:[
          'On alkaline soil, micronutrient sprays (boron, zinc) may be needed.',
          'Add compost and crop residue to keep soil friable.'
        ],
        irrigation:[
          'Keep soil moist but not sticky from flowering to pod filling.',
          'Stop irrigation 10‚Äì15 days before digging.'
        ],
        fertiliser:[
          'Use SSP as phosphorus source; it also gives sulphur.',
          'Do not overuse nitrogen; groundnut fixes its own nitrogen.'
        ]
      },
      {id:'mustard',name:'Mustard',group:'oilseed',phMin:6.0,phMax:7.5,
        improveLow:[
          'Apply lime in strips before sowing where soil is very acidic.',
          'Use FYM or compost at least once in rotation.'
        ],
        improveHigh:[
          'Use sulphur‚Äërich fertiliser on high pH soil.',
          'Avoid saline irrigation water, especially at germination.'
        ],
        irrigation:[
          'Key irrigations are at flowering and pod filling.',
          'Do not keep standing water around plants.'
        ],
        fertiliser:[
          'Use NPK as per recommendation; sulphur is important for oil content.',
          'Use boron where flower drop is common and soil test shows deficiency.'
        ]
      },
      {id:'chickpea',name:'Chickpea (gram)',group:'pulse',phMin:6.0,phMax:8.0,
        improveLow:[
          'In strongly acidic soils, light liming before chickpea helps nodules.',
          'Use raised beds in high rainfall areas.'
        ],
        improveHigh:[
          'Use organic matter to keep soil open on high pH fields.',
          'Avoid heavy pre‚Äësowing irrigation that leaves soil sticky.'
        ],
        irrigation:[
          'Mostly grown on stored soil moisture; avoid excess water.',
          'If water is available, one irrigation at pod filling can boost yield.'
        ],
        fertiliser:[
          'Treat seed with Rhizobium culture.',
          'Apply basal phosphorus; chickpea responds well to P.'
        ]
      },
      {id:'pigeonpea',name:'Pigeonpea (arhar)',group:'pulse',phMin:6.0,phMax:7.5,
        improveLow:[
          'Use lime and FYM on very acidic land before sowing.',
          'Keep good drainage so roots are not standing in water.'
        ],
        improveHigh:[
          'In alkaline areas, select tolerant varieties recommended locally.',
          'Grow green manures or grasses in rotation to improve structure.'
        ],
        irrigation:[
          'Crop tolerates short drought but needs water at flowering and pod set.',
          'In heavy rains, drain extra water quickly.'
        ],
        fertiliser:[
          'Apply small starter dose of nitrogen and good phosphorus.',
          'Avoid deep tillage near roots once crop is established.'
        ]
      },
      {id:'potato',name:'Potato',group:'vegetable',phMin:5.0,phMax:6.5,
        improveLow:[
          'If pH is below 5, moderate with small lime doses as per soil test.',
          'Add plenty of FYM for soft, loose soil.'
        ],
        improveHigh:[
          'Above pH 7, common scab increases; avoid fresh undecomposed manure.',
          'Use sulphur‚Äëbased fertilisers to slightly lower pH near tubers.'
        ],
        irrigation:[
          'Keep soil moist from tuber initiation to bulking.',
          'Avoid waterlogging; it causes rots.'
        ],
        fertiliser:[
          'Use more potash for firm tubers.',
          'Split nitrogen into 2‚Äì3 doses; do not apply late heavy N.'
        ]
      },
      {id:'tomato',name:'Tomato',group:'vegetable',phMin:6.0,phMax:7.5,
        improveLow:[
          'On very acidic soil, apply lime to reduce blossom‚Äëend rot.',
          'Use compost to buffer acidity and hold water.'
        ],
        improveHigh:[
          'At high pH, use micronutrient sprays when leaves turn pale.',
          'Mulch with straw or crop waste to keep roots cool.'
        ],
        irrigation:[
          'Keep moisture even; big swings cause fruit cracking.',
          'Avoid wetting foliage late evening to reduce disease.'
        ],
        fertiliser:[
          'Use basal NPK and extra potash for good fruit quality.',
          'Too much nitrogen gives leaves but few fruits.'
        ]
      },
      {id:'onion',name:'Onion',group:'vegetable',phMin:6.0,phMax:7.0,
        improveLow:[
          'Apply lime and FYM one season before onion on very acidic soil.',
          'Use raised beds so bulbs do not sit in water.'
        ],
        improveHigh:[
          'High pH can lock micronutrients; use foliar spray if tips yellow.',
          'Keep adding compost so bulbs grow in soft soil.'
        ],
        irrigation:[
          'Give light but frequent irrigation; roots are shallow.',
          'Stop irrigation 10‚Äì12 days before harvest for better storage.'
        ],
        fertiliser:[
          'Onion needs more potash and sulphur; use SSP and MOP as per dose.',
          'Do not apply heavy fresh manure just before planting.'
        ]
      },
      {id:'okra',name:'Okra (bhindi)',group:'vegetable',phMin:6.0,phMax:7.5,
        improveLow:[
          'Apply lime where pH is very low and plants look stunted.',
          'Use FYM and compost to keep soil open.'
        ],
        improveHigh:[
          'On alkaline soil, avoid salty irrigation water.',
          'Use drip or furrow to keep root zone comfortable.'
        ],
        irrigation:[
          'Irrigate regularly during flowering and fruiting.',
          'Avoid waterlogging; wilt disease spreads fast in wet soil.'
        ],
        fertiliser:[
          'Use balanced NPK and one or two sprays of micronutrient mixture.',
          'Do not harvest fruits when very old; it weakens the plant.'
        ]
      },
      {id:'brinjal',name:'Brinjal (eggplant)',group:'vegetable',phMin:5.5,phMax:7.0,
        improveLow:[
          'Light liming and FYM help in very acidic fields.',
          'Keep soil well drained to avoid root rots.'
        ],
        improveHigh:[
          'High pH may reduce iron and manganese; use foliar mixture.',
          'Mulch heavily to keep moisture steady.'
        ],
        irrigation:[
          'Give regular irrigation; long dry spell causes flower drop.',
          'Increase frequency in light sandy soils.'
        ],
        fertiliser:[
          'Apply basal NPK and top‚Äëdress nitrogen in splits.',
          'Use organic manures to support long picking season.'
        ]
      },
      {id:'banana',name:'Banana',group:'fruit',phMin:5.5,phMax:7.5,
        improveLow:[
          'Apply lime and plenty of FYM in very acidic soil.',
          'Use good drainage; roots do not like stagnant water.'
        ],
        improveHigh:[
          'Leach salts with heavy irrigation using good quality water if soil is sodic.',
          'Mulch thickly with crop residues around plant base.'
        ],
        irrigation:[
          'Banana is very sensitive to drought; do not let soil dry out.',
          'Avoid waterlogging to prevent root and corm rots.'
        ],
        fertiliser:[
          'Give fertiliser in ring around plant, not touching pseudostem.',
          'Split nitrogen and potash in many small doses through the year.'
        ]
      },
      {id:'mango',name:'Mango',group:'fruit',phMin:5.5,phMax:7.5,
        improveLow:[
          'Apply lime before planting new orchard on very acidic soil.',
          'Grow green manure crops in basins and incorporate them.'
        ],
        improveHigh:[
          'On high pH, spray micronutrients at new flush.',
          'Mulch basins to reduce cracking and salt build‚Äëup.'
        ],
        irrigation:[
          'Young plants need regular water in summer.',
          'Avoid irrigation close to flowering flush where recommended.'
        ],
        fertiliser:[
          'Give FYM plus NPK dose once or twice a year around drip line.',
          'Adjust dose by tree age; do not over‚Äëfertilise old trees.'
        ]
      },
      {id:'citrus',name:'Citrus (orange/limon)',group:'fruit',phMin:5.5,phMax:7.5,
        improveLow:[
          'Correct very acidic soil with lime before planting.',
          'Use FYM and compost shallowly as roots stay near surface.'
        ],
        improveHigh:[
          'High pH often causes micronutrient deficiency; use chelated sprays.',
          'Avoid piling fertiliser next to trunk; place in circular band.'
        ],
        irrigation:[
          'Irrigate at longer intervals but with enough water to wet root zone.',
          'Provide drainage in heavy soils to avoid root rot.'
        ],
        fertiliser:[
          'Use NPK in 2‚Äì3 splits per year along with FYM.',
          'Regular micronutrient spray keeps leaves dark green.'
        ]
      },
      {id:'tea',name:'Tea',group:'plantation',phMin:4.5,phMax:6.0,
        improveLow:[
          'Tea likes acidic soil; only correct if pH is extremely low.',
          'Use organic mulches to protect surface roots.'
        ],
        improveHigh:[
          'If pH is too high, use ammonium sulphate and organic matter to lower it slowly.',
          'Avoid extra liming near mature bushes.'
        ],
        irrigation:[
          'In dry spells, give light irrigation or sprinkler where possible.',
          'Mulch helps keep soil cool and moist.'
        ],
        fertiliser:[
          'Follow regional tea board fertiliser schedule.',
          'Do not apply high doses of fertiliser in one shot on dry soil.'
        ]
      },
      {id:'sunflower',name:'Sunflower',group:'oilseed',phMin:6.0,phMax:7.5,
        improveLow:[
          'Use lime and FYM on very acidic soils before sowing.',
          'Avoid compaction; keep soil well tilled and open.'
        ],
        improveHigh:[
          'On high pH soils, boron may be low; use small boron dose if advised.',
          'Add crop residues back instead of burning.'
        ],
        irrigation:[
          'Moisture must be good at flowering and grain filling.',
          'Do not over‚Äëirrigate; waterlogging reduces oil content.'
        ],
        fertiliser:[
          'Use NPK dose recommended for area; potash is important for oil.',
          'Keep weeds under control in early growth for good fertiliser response.'
        ]
      },
      {id:'millet',name:'Pearl millet (bajra)',group:'cereal',phMin:5.5,phMax:7.5,
        improveLow:[
          'Use FYM and light liming where pH is very low.',
          'Select tolerant varieties suited to local dryland conditions.'
        ],
        improveHigh:[
          'Millet tolerates slightly higher pH but avoid very sodic patches.',
          'Increase organic matter to keep soil soft.'
        ],
        irrigation:[
          'Often grown on rainfall; if irrigated, avoid stress at booting and flowering.',
          'Do not waterlog light sandy soils.'
        ],
        fertiliser:[
          'Apply basal NPK and one top dressing of nitrogen.',
          'Use seed treatment and proper spacing for better fertiliser use.'
        ]
      }
    ];

    /* ========= pH HELPER ========= */
    const phInput=document.getElementById('phInput');
    const btnUseLatest=document.getElementById('btnUseLatest');
    const btnCheckPh=document.getElementById('btnCheckPh');
    const phStatusBox=document.getElementById('phStatusBox');
    const bestCropsBox=document.getElementById('bestCropsBox');
    const bestCropsPills=document.getElementById('bestCropsPills');
    const bestCropsNote=document.getElementById('bestCropsNote');

    function describePH(p){
      const c=classifyPH(p);
      if(c.band==='unknown')return'Enter a pH value between 0 and 14.';
      if(c.band==='neutral'){
        return'pH '+p.toFixed(2)+' is close to neutral. Most crops can grow well if soil and water are managed properly.';
      }
      return'pH '+p.toFixed(2)+' is '+c.label+
             '. Some crops will struggle unless you correct pH or choose tolerant crops.';
    }

    function updatePHStatus(p){
      if(isNaN(p)){
        phStatusBox.textContent='';
        bestCropsBox.style.display='none';
        return;
      }
      phStatusBox.textContent=describePH(p);
      const good=FARM_CROPS.filter(c=>p>=c.phMin && p<=c.phMax);
      const near=FARM_CROPS.filter(c=>p>=c.phMin-0.4 && p<=c.phMax+0.4 && !good.includes(c));
      const list=(good.length?good:near).slice(0,8);
      bestCropsPills.innerHTML='';
      list.forEach(crop=>{
        const pill=document.createElement('span');
        pill.className='pill';
        pill.textContent=crop.name;
        bestCropsPills.appendChild(pill);
      });
      if(!list.length){
        bestCropsNote.textContent='This pH is hard for most common crops. Work on pH correction first, then plant.';
      }else if(good.length>=6){
        bestCropsNote.textContent='This pH suits many crops. Choose based on climate, soil and market price.';
      }else{
        bestCropsNote.textContent='Only some crops are comfortable at this pH. Try these first or correct pH before other crops.';
      }
      bestCropsBox.style.display='block';
    }

    btnUseLatest.addEventListener('click',()=>{
      const r=loadLatestReading();
      if(!r){
        phStatusBox.textContent='No saved reading found. Go to Measure page, test water and press Save.';
        bestCropsBox.style.display='none';
        return;
      }
      phInput.value=r.ph.toFixed(2);
      updatePHStatus(r.ph);
    });

    btnCheckPh.addEventListener('click',()=>{
      const v=parseFloat(phInput.value);
      if(isNaN(v)){
        phStatusBox.textContent='Type a pH value or use the latest saved reading first.';
        bestCropsBox.style.display='none';
        return;
      }
      updatePHStatus(v);
      const currentCropId=document.getElementById('cropSelect').value;
      if(currentCropId)showCropAdvice(currentCropId,v);
    });

    /* ========= pH IMPROVEMENT ========= */
    const phImprove=document.getElementById('phImprove');
    const btnImprove=document.getElementById('btnImprove');
    const improveCards=document.getElementById('improveCards');
    const shortTermList=document.getElementById('shortTermList');
    const longTermList=document.getElementById('longTermList');

    function buildImproveTips(p){
      const short=[],long=[];
      if(p<5.5){
        short.push(
          'For nurseries and young plants, mix this water with cleaner source or use rainwater if possible.',
          'Apply lime or dolomite only as per soil test; mix well into top 10‚Äì15 cm soil.',
          'Avoid very strong single dose of acidic fertilisers like only urea; use balanced NPK.'
        );
        long.push(
          'Add FYM, compost and crop residues every season to slowly raise pH.',
          'Grow deep‚Äërooted legumes and leave roots in soil after harvest.',
          'Reduce burning of crop waste; keep organic matter on the field.'
        );
      }else if(p<6.5){
        short.push(
          'For sensitive vegetables, apply small lime dose in planting rows, not on whole field.',
          'Check pH at more than one spot; some patches may be lower than others.'
        );
        long.push(
          'Follow rotation with at least one legume crop to keep soil stable.',
          'Use complex fertilisers (NPK) instead of only nitrogen.'
        );
      }else if(p<=7.8){
        short.push(
          'This pH is close to ideal. Focus on clean water, correct fertiliser dose and good drainage.',
          'Test water and soil once a year to confirm pH is staying stable.'
        );
        long.push(
          'Keep soil covered with mulches or cover crops so biology remains active.',
          'Reduce very heavy tillage which breaks soil structure.'
        );
      }else if(p<=8.5){
        short.push(
          'Avoid long flood irrigation with this water; give shorter, controlled irrigation.',
          'Mix this water with better‚Äëquality source if you have two wells or canals.'
        );
        long.push(
          'Use gypsum on sodic soil after lab test confirms requirement.',
          'Grow green manure, add press‚Äëmud or compost and do deep ploughing once in few years.'
        );
      }else{
        short.push(
          'Do not use this water for nurseries or pots unless mixed with better water.',
          'Try to use this water only on more tolerant crops or for leaching salts.'
        );
        long.push(
          'Plan a long‚Äëterm reclamation programme with experts; may include drainage, gypsum and crop choice.',
          'Shift to salt‚Äëtolerant crops until soil and water quality improve.'
        );
      }
      return{short,long};
    }

    btnImprove.addEventListener('click',()=>{
      const v=parseFloat(phImprove.value);
      if(isNaN(v)){
        improveCards.style.display='none';
        return;
      }
      const tips=buildImproveTips(v);
      shortTermList.innerHTML='';
      longTermList.innerHTML='';
      tips.short.forEach(t=>{const li=document.createElement('li');li.textContent=t;shortTermList.appendChild(li);});
      tips.long.forEach(t=>{const li=document.createElement('li');li.textContent=t;longTermList.appendChild(li);});
      improveCards.style.display='block';
    });

    /* ========= CROP ADVICE ========= */
    const cropSelect=document.getElementById('cropSelect');
    const cropAdviceArea=document.getElementById('cropAdviceArea');
    const cropRangeText=document.getElementById('cropRangeText');
    const cropImproveList=document.getElementById('cropImproveList');
    const irrigationList=document.getElementById('irrigationList');
    const managementList=document.getElementById('managementList');

    function populateCropSelect(){
      const sorted=[...FARM_CROPS].sort((a,b)=>a.name.localeCompare(b.name));
      sorted.forEach(crop=>{
        const opt=document.createElement('option');
        opt.value=crop.id;
        opt.textContent=crop.name;
        cropSelect.appendChild(opt);
      });
    }

    function showCropAdvice(cropId,pVal){
      const crop=FARM_CROPS.find(c=>c.id===cropId);
      if(!crop){
        cropAdviceArea.style.display='none';
        return;
      }
      const p=pVal;
      let statusText='';
      if(!isNaN(p)){
        if(p>=crop.phMin && p<=crop.phMax){
          statusText='Your pH '+p.toFixed(2)+' is inside the good range for this crop.';
        }else if(prop.phMin){
          statusText='Your pH '+p.toFixed(2)+' is lower than this crop likes. Water and soil are more acidic.';
        }else{
          statusText='Your pH '+p.toFixed(2)+' is higher than this crop likes. Water and soil are more alkaline.';
        }
      }else{
        statusText='Enter or load pH on the left to check fit more clearly.';
      }
      cropRangeText.textContent=crop.name+' grows best between pH '+crop.phMin.toFixed(1)+' and '+crop.phMax.toFixed(1)+'. '+statusText;

      cropImproveList.innerHTML='';
      irrigationList.innerHTML='';
      managementList.innerHTML='';

      const lowSide=crop.improveLow||[];
      const highSide=crop.improveHigh||[];
      let improveSource=[];
      if(!isNaN(p)){
        if(prop.phMin) improveSource=lowSide;
        else if(p>crop.phMax) improveSource=highSide;
        else improveSource=lowSide.concat(highSide);
      }else{
        improveSource=lowSide.concat(highSide);
      }
      improveSource.forEach(txt=>{
        const li=document.createElement('li');
        li.textContent=txt;
        cropImproveList.appendChild(li);
      });
      (crop.irrigation||[]).forEach(txt=>{
        const li=document.createElement('li');
        li.textContent=txt;
        irrigationList.appendChild(li);
      });
      (crop.fertiliser||[]).forEach(txt=>{
        const li=document.createElement('li');
        li.textContent=txt;
        managementList.appendChild(li);
      });

      cropAdviceArea.style.display='block';
    }

    cropSelect.addEventListener('change',()=>{
      const id=cropSelect.value;
      if(!id){
        cropAdviceArea.style.display='none';
        return;
      }
      const v=parseFloat(phInput.value);
      showCropAdvice(id,v);
    });

    /* ========= INIT ========= */
    populateCropSelect();
    updateLatestStatusBox();
  </script>
</body>
</html>
