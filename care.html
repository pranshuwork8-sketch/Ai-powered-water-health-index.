<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Water Health Index - Care</title>
  <style>
    :root{
      --sidebar-wide:225px;
      --sidebar-narrow:64px;
      --accent:#51daf7;
      --active:#48e8c2;
      --card-bg:#1d334b;
      --shadow:0 8px 32px #17487d40;
      --good:#26c96a;
      --med:#f1c644;
      --poor:#e0526a;
      --unknown:#607d8b;
    }
    html,body{
      margin:0;
      background:
        linear-gradient(120deg,rgba(81,218,247,0.74),rgba(23,72,125,0.81) 85%),
        url("assets/bg-water.jpg");
      background-size:cover,cover;
      background-repeat:no-repeat,no-repeat;
      background-attachment:fixed;
      color:#e3fbfa;
      font-family:"Times New Roman",Times,serif;
      min-height:100vh;
      box-sizing:border-box;
    }
    body{position:relative;}

    .sidebar{
      width:var(--sidebar-wide);
      min-width:210px;
      max-width:380px;
      background:rgba(16,38,54,0.98);
      box-shadow:3px 0 20px #143d5344;
      position:fixed;left:0;top:0;bottom:0;
      display:flex;flex-direction:column;
      z-index:2000;overflow-y:auto;
    }
    .sidebar-header{
      display:flex;flex-direction:column;
      align-items:center;margin:2.1rem 0 2.3rem;
    }
    .logo-img{
      font-size:2.7rem;
      animation:waveMotion 2.3s infinite alternate cubic-bezier(.55,.06,.87,.6);
      filter:drop-shadow(0 2px 19px #51daf7a0);
    }
    .logo-text{
      color:var(--accent);
      font-size:2.1rem;font-weight:bold;
      text-align:center;letter-spacing:.02em;line-height:1.16;
    }
    @keyframes waveMotion{
      0%{transform:translateY(0);}
      100%{transform:translateY(-8px);}
    }
    .sidebar nav{display:flex;flex-direction:column;gap:1.05rem;margin-bottom:auto;}
    .nav-link{
      color:#e3fbfa;text-decoration:none;
      padding:.7rem 1.15rem;font-size:1.09rem;
      display:flex;align-items:center;gap:.7rem;
      border-radius:13px;margin:0 .4rem;
      transition:background .12s,color .12s;
      font-weight:500;
    }
    .nav-link.active,.nav-link:hover{
      background:var(--active);color:#154b68;
    }
    .sidebar-footer{
      color:#9ee8ff;font-size:.95rem;font-style:italic;
      padding:1.1rem .8rem 1rem;text-align:center;
    }

    .main-wrap{
      margin-left:var(--sidebar-wide);
      padding:4vw 4vw 3vw 4vw;
      min-height:100vh;box-sizing:border-box;
      display:flex;flex-direction:column;position:relative;z-index:1;
    }

    .care-header{
      margin-top:4vw;margin-left:1vw;margin-bottom:1.8rem;
      padding:.8rem 1rem 1rem;border-radius:18px;
      background:linear-gradient(135deg,rgba(9,39,60,0.9),rgba(17,64,97,0.85));
    }
    .care-title{
      font-size:2.1rem;color:#f5feff;font-weight:bold;
      letter-spacing:.03em;margin:0 0 .4rem;
      text-shadow:0 3px 14px #0b2236;
    }
    .care-subtitle{
      margin:0;font-size:1.02rem;color:#d9fbff;max-width:760px;
    }

    .care-layout{
      display:flex;flex-wrap:wrap;gap:1.7rem;
      margin-left:1vw;margin-right:1.3vw;margin-bottom:2.2rem;
    }
    .care-left,.care-right{flex:1 1 360px;min-width:0;}
    .care-card{
      background:#1d334b;border-radius:26px;
      padding:1.5rem 1.4rem;box-shadow:var(--shadow);
      border:1.5px solid #107dac;box-sizing:border-box;
    }

    .section{margin-top:1.1rem;padding-top:.7rem;border-top:1px solid rgba(160,220,240,0.26);}
    .section:first-of-type{margin-top:.2rem;padding-top:0;border-top:none;}
    .section-title{font-weight:bold;color:#39bbe9;margin-bottom:.35rem;font-size:1rem;}
    .section-note{font-size:.88rem;color:#b8e3ff;margin-top:.3rem;}

    .controls-row{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;margin:.2rem 0 .5rem;}
    .btn-main{
      border-radius:8px;border:none;padding:.45rem .95rem;
      font-family:inherit;font-size:.96rem;font-weight:bold;
      cursor:pointer;background:#2cb5d6;color:#fff;
    }
    .btn-main:hover{background:#168eaf;}
    .btn-ghost{
      border-radius:8px;border:1px solid #3b7b95;
      background:transparent;padding:.42rem .9rem;
      font-family:inherit;font-size:.94rem;font-weight:bold;
      cursor:pointer;color:#cdefff;
    }
    .btn-ghost:hover{background:#182b35;}

    .reading-box{
      background:#1b3240;border-radius:13px;
      padding:.7rem .8rem .8rem;font-size:.9rem;
      color:#e5fbff;display:none;
    }
    .reading-top{
      display:flex;justify-content:space-between;gap:.6rem;
      flex-wrap:wrap;align-items:center;
    }
    .badge-band{
      padding:4px 9px;border-radius:999px;
      font-size:.82rem;font-weight:bold;color:#fff;
    }
    .band-good{background:var(--good);}
    .band-med{background:var(--med);color:#333;}
    .band-poor{background:var(--poor);}
    .band-unknown{background:var(--unknown);}

    .reading-details{
      display:flex;flex-wrap:wrap;gap:.6rem;
      margin-top:.4rem;font-size:.86rem;color:#d1f3ff;
    }
    .reading-details span{
      padding:2px 6px;border-radius:7px;background:#102632;
    }

    .care-plan-cards{display:flex;flex-direction:column;gap:.6rem;margin-top:.3rem;}
    .care-plan-card{
      background:#1b3441;border-radius:10px;
      padding:.6rem .7rem .7rem;font-size:.9rem;color:#e5fbff;
    }
    .care-plan-title{font-weight:bold;color:#39bbe9;margin-bottom:.2rem;}
    .care-plan-card ul{margin:.2rem 0 0 1.1rem;padding:0;list-style:disc;font-size:.88rem;}

    .checklist{list-style:none;margin:.25rem 0 0 .1rem;padding:0;font-size:.88rem;}
    .checklist li{margin-bottom:.25rem;display:flex;align-items:flex-start;gap:.35rem;}
    .checklist input[type="checkbox"]{margin-top:.18rem;}

    .symptom-controls{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;}
    .symptom-controls label{font-weight:bold;color:#39bbe9;font-size:.96rem;}
    .symptom-controls select{
      min-width:170px;padding:.4rem .7rem;border-radius:9px;
      border:1px solid #27536b;background:#102636;
      color:#e7fbff;font-family:inherit;font-size:.95rem;
    }
    .symptom-cards{margin-top:.4rem;display:none;}

    .reminder-banner{
      margin-top:.45rem;background:#193241;border-radius:10px;
      padding:.45rem .6rem;font-size:.86rem;color:#d3f2ff;display:none;
    }

    .library-section-title{font-weight:bold;color:#39bbe9;margin:.1rem 0 .4rem;font-size:1.02rem;}
    .library-card{
      background:#1b3441;border-radius:10px;
      padding:.6rem .7rem .7rem;font-size:.9rem;color:#e5fbff;
      margin-top:.55rem;
    }
    .library-card-title{font-weight:bold;color:#39bbe9;margin-bottom:.2rem;}
    .library-card ul{margin:.2rem 0 0 1.1rem;padding:0;list-style:disc;font-size:.88rem;}

    .care-footer{
      margin-top:1.2rem;margin-left:1vw;
      font-size:.88rem;color:#9ee8ff;opacity:.9;
    }

    @media(max-width:900px){
      .sidebar{width:var(--sidebar-narrow)!important;min-width:var(--sidebar-narrow);max-width:var(--sidebar-narrow);}
      .sidebar-header{margin:1rem 0;}
      .logo-img{font-size:2.1rem;}
      .logo-text{font-size:1.1rem;}
      .sidebar nav .nav-link{font-size:0;padding:.9rem .3rem;justify-content:center;}
      .sidebar nav .nav-link .label{display:none;}
      .main-wrap{margin-left:var(--sidebar-narrow)!important;padding:4vw 2.2vw 3vw;}
      .care-header{margin-top:18vw;margin-left:.3rem;}
      .care-layout{margin-left:.3rem;margin-right:.3rem;flex-direction:column;}
    }
    @media(max-width:520px){
      .care-title{font-size:1.45rem;}
      .care-header{margin-top:22vw;}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-img" aria-hidden="true">üåä</span>
      <span class="logo-text">Water<br>Index</span>
    </div>
    <nav>
      <a href="index.html" class="nav-link"><span aria-hidden="true">üè†</span><span class="label">Home</span></a>
      <a href="measure.html" class="nav-link"><span aria-hidden="true">üß™</span><span class="label">Measure</span></a>
      <a href="map.html" class="nav-link"><span aria-hidden="true">üó∫Ô∏è</span><span class="label">Map</span></a>
      <a href="care.html" class="nav-link active"><span aria-hidden="true">üíß</span><span class="label">Care</span></a>
      <a href="farmers.html" class="nav-link"><span aria-hidden="true">üåæ</span><span class="label">Farmers assistant</span></a>
      <a href="chart.html" class="nav-link"><span aria-hidden="true">üìä</span><span class="label">Chart</span></a>
      <a href="learn.html" class="nav-link"><span aria-hidden="true">üìö</span><span class="label">Learn</span></a>
      <a href="buykit.html" class="nav-link"><span aria-hidden="true">üõí</span><span class="label">Buy kit</span></a>
      <a href="about.html" class="nav-link"><span aria-hidden="true">‚ÑπÔ∏è</span><span class="label">About</span></a>
    </nav>
    <footer class="sidebar-footer">
      &copy; 2025 Water Health Index ¬∑ Regional project
    </footer>
  </aside>

  <!-- Main -->
  <div class="main-wrap" id="mainWrap">
    <header class="care-header">
      <h1 class="care-title">Water care &amp; actions</h1>
      <p class="care-subtitle">
        See what your latest reading means, get a simple care plan for your water,
        and learn how to protect wells, tanks, ponds, and community water bodies.
      </p>
    </header>

    <section class="care-layout">
      <!-- Left -->
      <div class="care-left">
        <div class="care-card">
          <!-- 1. Latest reading -->
          <div class="section">
            <div class="section-title">1. My latest reading</div>
            <div class="controls-row">
              <button id="loadLast" class="btn-main">Load latest from history</button>
              <button id="clearChecks" class="btn-ghost">Clear care checklist</button>
            </div>
            <div class="reading-box" id="readingBox">
              <div class="reading-top">
                <div>
                  <div id="readingWhen"></div>
                  <div id="readingPlace" style="font-size:.84rem;color:#c7eafe;"></div>
                </div>
                <div><span id="bandLabel" class="badge-band band-unknown">No index</span></div>
              </div>
              <div class="reading-details" id="readingDetails"></div>
            </div>
            <p class="section-note" id="noReadingNote">
              Load the latest reading from the Measure page to see a care plan based on its index and pH.
            </p>
          </div>

          <!-- 2. Care plan -->
          <div class="section" id="carePlanSection" style="display:none;">
            <div class="section-title">2. Care plan for this band</div>
            <div class="care-plan-cards">
              <div class="care-plan-card">
                <div class="care-plan-title">Health &amp; safety first</div>
                <ul id="safetyList"></ul>
              </div>
              <div class="care-plan-card">
                <div class="care-plan-title">Improve water quality</div>
                <ul id="improveList"></ul>
              </div>
              <div class="care-plan-card">
                <div class="care-plan-title">When to seek expert help</div>
                <ul id="expertList"></ul>
              </div>
              <div class="care-plan-card">
                <div class="care-plan-title">My care checklist</div>
                <ul class="checklist" id="checklist"></ul>
              </div>
            </div>
          </div>

          <!-- 3. Symptom helper -->
          <div class="section">
            <div class="section-title">3. What does your water look like?</div>
            <div class="symptom-controls">
              <label for="symptomSelect">Choose a symptom</label>
              <select id="symptomSelect">
                <option value="none" selected>-- Select --</option>
                <option value="muddy">Looks brown or muddy</option>
                <option value="green">Green layer / algae on top</option>
                <option value="smell">Strong smell (rotten egg / sewage)</option>
                <option value="scale">White scale on taps / utensils</option>
                <option value="foam">Foam or detergent bubbles</option>
              </select>
            </div>
            <div class="symptom-cards" id="symptomCards">
              <div class="care-plan-cards">
                <div class="care-plan-card">
                  <div class="care-plan-title">Likely causes</div>
                  <ul id="symptomCauseList"></ul>
                </div>
                <div class="care-plan-card">
                  <div class="care-plan-title">What you can do now</div>
                  <ul id="symptomActionList"></ul>
                </div>
              </div>
            </div>
          </div>

          <!-- 4. Reminders -->
          <div class="section">
            <div class="section-title">4. Reminders</div>
            <div class="controls-row">
              <label for="reminderSelect">Check water every</label>
              <select id="reminderSelect">
                <option value="0">No reminder</option>
                <option value="7">7 days</option>
                <option value="30">30 days</option>
                <option value="90">90 days</option>
              </select>
              <button id="saveReminder" class="btn-ghost">Save reminder</button>
            </div>
            <div class="reminder-banner" id="reminderBanner"></div>
          </div>
        </div>
      </div>

      <!-- Right -->
      <div class="care-right">
        <div class="care-card">
          <div class="library-section-title">Care library</div>

          <div class="library-card">
            <div class="library-card-title">At home (drinking &amp; cooking)</div>
            <ul id="homeCareList"></ul>
          </div>

          <div class="library-card">
            <div class="library-card-title">For farms &amp; ponds</div>
            <ul id="farmCareList"></ul>
          </div>

          <div class="library-card">
            <div class="library-card-title">Community water bodies</div>
            <ul id="communityCareList"></ul>
          </div>

          <div class="library-card">
            <div class="library-card-title">Did you know?</div>
            <ul id="factsList"></ul>
          </div>
        </div>
      </div>
    </section>

    <p class="care-footer">
      Tip: Use this care plan together with the Map and Farmers Assistant pages to decide next actions for your family, farm, or community.
    </p>
  </div>

  <script>
    // ---------- Static English text used by widgets ----------
    const strings = {
      last_saved_prefix: "Last saved: ",
      location_prefix: "Location: ",
      band_good: "Good quality",
      band_med: "Moderate quality",
      band_poor: "Poor quality",
      band_unknown: "No index",
      details_index: "Index",
      details_ph: "pH",
      details_temp: "Temp",
      details_turb: "Turbidity",
      reminder_due: "Reminder: it has been {n} days, please test your water again.",
      reminder_ok: "You tested {n} days ago. Keep an eye and test again when the reminder is due.",
      reminder_saved: "Reminder saved for every {n} days.",
      carePlan: {
        good: {
          safety: [
            "Water is generally safe if the source is protected; still boil for babies and people with weak immunity.",
            "Store drinking water in clean, covered containers and avoid dipping hands or cups."
          ],
          improve: [
            "Clean storage tanks and household filters at least once every 1‚Äì3 months.",
            "Keep soaps, detergents and oils away from wells and tanks."
          ],
          expert: [
            "Repeat tests if colour, smell or taste changes suddenly.",
            "Share good results with neighbours so they also keep the source clean."
          ]
        },
        med: {
          safety: [
            "Do not drink this water directly; always boil or filter before use.",
            "Avoid using it for infant feeding or very sick people."
          ],
          improve: [
            "Clean tanks, pipes and taps; remove settled sludge where possible.",
            "Improve drainage around wells so waste water does not flow back.",
            "Use simple home filters such as ceramic, RO or UV if available."
          ],
          expert: [
            "If several tests stay in the moderate band, ask local officials for a detailed lab test.",
            "Keep a small notebook of readings and cleaning dates."
          ]
        },
        poor: {
          safety: [
            "Do not use this water for drinking or cooking until new tests show improvement.",
            "Use bottled water, tanker water or public taps for drinking."
          ],
          improve: [
            "Look for sewage leaks, dumping or industrial discharge and report them.",
            "Use this water only for low‚Äëcontact tasks like floor cleaning or toilet flushing.",
            "Plan medium‚Äëterm fixes such as new wells or treatment units."
          ],
          expert: [
            "Send your results to the panchayat, water board or health department.",
            "If fish or animals are dying near the source, treat it as an emergency."
          ]
        },
        unknown: {
          safety: [
            "Test this water at least once before using it every day for drinking.",
            "If colour, smell or taste seems strange, treat it as unsafe until you test it."
          ],
          improve: [
            "Keep the area around the source clean and free from rubbish, oil and chemicals."
          ],
          expert: [
            "Report any suspected industrial or sewage pollution to authorities."
          ]
        }
      },
      checklistItems: [
        "I cleaned or inspected my storage tank or main container this month.",
        "I checked my usual source for new smells, colour change or oil/foam.",
        "I keep drinking water covered and use a tap or ladle instead of dipping cups.",
        "I avoid throwing chemicals, oil, medicine or plastic into drains or water bodies.",
        "I plan to re‚Äëtest this water within the reminder period."
      ],
      symptomOptions: {
        muddy: {
          causes: [
            "Heavy rain or upstream soil erosion has added a lot of mud.",
            "The pump or well is drawing water from near the bottom."
          ],
          actions: [
            "Let water settle in a clean bucket and pour off the clearer top layer.",
            "Filter through cloth or a cartridge before boiling.",
            "Reduce soil erosion into ponds and canals by keeping grass strips on the banks."
          ]
        },
        green: {
          causes: [
            "Extra fertiliser, detergents or sewage are feeding algal growth.",
            "Slow or stagnant water in strong sunlight favours algal blooms."
          ],
          actions: [
            "Do not drink or bathe in strongly green, smelly water.",
            "Stop fertiliser and detergent run‚Äëoff from flowing directly into ponds or tanks.",
            "Add shade or mixing where possible and ask fisheries staff if fish are present."
          ]
        },
        smell: {
          causes: [
            "Rotten‚Äëegg smell often comes from hydrogen sulphide in low‚Äëoxygen, rotting water.",
            "Sewage or industrial waste water may be entering the source."
          ],
          actions: [
            "Do not drink foul‚Äësmelling water even after boiling; find a safer source.",
            "Check for leaking toilets, drains or sewer lines and report them.",
            "Improve ventilation of storage tanks and keep rotting waste away from wells."
          ]
        },
        scale: {
          causes: [
            "White scale usually means hard water with high calcium and magnesium.",
            "Very hard water may also taste different because of dissolved salts."
          ],
          actions: [
            "Descale kettles and taps using mild vinegar or citric acid.",
            "Consider RO or softeners if hardness is very high.",
            "Use hard water mainly for washing and cleaning; keep softer sources for drinking."
          ]
        },
        foam: {
          causes: [
            "Detergents, soaps or other chemicals are entering the water body.",
            "Grey‚Äëwater or sewage may be going straight into drains or streams."
          ],
          actions: [
            "Avoid washing clothes or dishes directly in rivers, ponds or wells.",
            "Send grey‚Äëwater through soak pits or simple filter beds instead of open drains.",
            "Report persistent foam in public water bodies to local authorities."
          ]
        }
      },
      homeCareList: [
        "Boil or filter drinking water, especially for children and elders.",
        "Clean kitchen storage containers regularly and keep them covered.",
        "Store drinking water away from fuel, pesticides and strong cleaners."
      ],
      farmCareList: [
        "Avoid over‚Äëuse of fertilisers and pesticides near wells and ponds.",
        "Keep livestock sheds and manure pits away from drinking water sources.",
        "Plant grass or trees along field edges and canals to slow run‚Äëoff."
      ],
      communityCareList: [
        "Do not dump solid waste or plastic into ponds, lakes, rivers or drains.",
        "Organise periodic clean‚Äëups of local ponds, tanks and riverbanks.",
        "Report sewage leaks and industrial discharge to the local authority."
      ],
      factsList: [
        "Regular testing catches small changes before they become big health problems.",
        "Protecting the catchment area is often cheaper than treating polluted water.",
        "Simple actions at home and on farms can greatly reduce water contamination."
      ]
    };

    // ---------- Data from Measure page ----------
    let readings = [];
    try {
      readings = JSON.parse(localStorage.getItem("whReadings") || "[]");
      if (!Array.isArray(readings)) readings = [];
    } catch (e) { readings = []; }
    readings.forEach((r, i) => { if (r.id == null) r.id = i; });

    const urlParams = new URLSearchParams(window.location.search);
    const readingParam = urlParams.get("reading");
    let preselectedId = readingParam != null ? Number(readingParam) : null;

    let lastReading = null;
    let currentBand = "unknown";

    function classifyBand(idx){
      idx = Number(idx);
      if (isNaN(idx)) return "unknown";
      if (idx >= 70) return "good";
      if (idx >= 40) return "med";
      return "poor";
    }

    function bandTextAndClass(band){
      let text = strings.band_unknown;
      let cls = "band-unknown";
      if (band === "good"){ text = strings.band_good; cls = "band-good"; }
      else if (band === "med"){ text = strings.band_med; cls = "band-med"; }
      else if (band === "poor"){ text = strings.band_poor; cls = "band-poor"; }
      return { text, cls };
    }

    function renderReading(){
      const box = document.getElementById("readingBox");
      const detailsEl = document.getElementById("readingDetails");
      const whenEl = document.getElementById("readingWhen");
      const placeEl = document.getElementById("readingPlace");
      const bandEl = document.getElementById("bandLabel");
      const noteEl = document.getElementById("noReadingNote");

      if (!lastReading){
        box.style.display = "none";
        noteEl.style.display = "block";
        document.getElementById("carePlanSection").style.display = "none";
        return;
      }

      box.style.display = "block";
      noteEl.style.display = "none";

      whenEl.textContent = strings.last_saved_prefix + (lastReading.when || "‚Äì");
      placeEl.textContent = lastReading.place ? (strings.location_prefix + lastReading.place) : "";

      const indexVal = Number(lastReading.index);
      const band = classifyBand(indexVal);
      currentBand = band;

      const bt = bandTextAndClass(band);
      bandEl.textContent = bt.text;
      bandEl.className = "badge-band " + bt.cls;

      detailsEl.innerHTML = "";
      function addChip(label, value){
        if (value === undefined || value === null || value === "") return;
        const span = document.createElement("span");
        span.textContent = label + " " + value;
        detailsEl.appendChild(span);
      }
      addChip(strings.details_index, isNaN(indexVal) ? "‚Äì" : indexVal);
      addChip(strings.details_ph, lastReading.ph);
      addChip(strings.details_temp, lastReading.temp);
      addChip(strings.details_turb, lastReading.turb);

      renderCarePlan(band);
    }

    function renderCarePlan(band){
      const sec = document.getElementById("carePlanSection");
      const planAll = strings.carePlan;
      const plan = planAll[band] || planAll.unknown;
      if (!plan){ sec.style.display = "none"; return; }
      sec.style.display = "block";

      const safetyList = document.getElementById("safetyList");
      const improveList = document.getElementById("improveList");
      const expertList = document.getElementById("expertList");
      safetyList.innerHTML = "";
      improveList.innerHTML = "";
      expertList.innerHTML = "";

      function fill(ul, arr){
        (arr || []).forEach(text => {
          const li = document.createElement("li");
          li.textContent = text;
          ul.appendChild(li);
        });
      }
      fill(safetyList, plan.safety);
      fill(improveList, plan.improve);
      fill(expertList, plan.expert);
    }

    // ---------- Checklist ----------
    const checklistEl = document.getElementById("checklist");
    const CHECK_KEY = "whicarechecks";
    function loadChecks(){
      try{
        const obj = JSON.parse(localStorage.getItem(CHECK_KEY));
        return (obj && typeof obj === "object") ? obj : {};
      }catch(e){ return {}; }
    }
    function saveChecks(obj){
      localStorage.setItem(CHECK_KEY, JSON.stringify(obj || {}));
    }
    function renderChecklist(){
      const items = strings.checklistItems;
      const state = loadChecks();
      checklistEl.innerHTML = "";
      items.forEach((text, idx) => {
        const id = "check" + idx;
        const li = document.createElement("li");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.checked = !!state[id];
        cb.addEventListener("change", () => {
          const st = loadChecks();
          st[id] = cb.checked;
          saveChecks(st);
        });
        const lbl = document.createElement("label");
        lbl.setAttribute("for", id);
        lbl.textContent = text;
        li.appendChild(cb);
        li.appendChild(lbl);
        checklistEl.appendChild(li);
      });
    }
    document.getElementById("clearChecks").addEventListener("click", () => {
      saveChecks({});
      renderChecklist();
    });

    // ---------- Symptom helper ----------
    const symptomSelect = document.getElementById("symptomSelect");
    const symptomCards = document.getElementById("symptomCards");
    const symptomCauseList = document.getElementById("symptomCauseList");
    const symptomActionList = document.getElementById("symptomActionList");

    function renderSymptom(){
      const val = symptomSelect.value;
      const opts = strings.symptomOptions;
      if (!opts[val] || val === "none"){
        symptomCards.style.display = "none";
        symptomCauseList.innerHTML = "";
        symptomActionList.innerHTML = "";
        return;
      }
      const info = opts[val];
      symptomCauseList.innerHTML = "";
      symptomActionList.innerHTML = "";
      (info.causes || []).forEach(text => {
        const li = document.createElement("li");
        li.textContent = text;
        symptomCauseList.appendChild(li);
      });
      (info.actions || []).forEach(text => {
        const li = document.createElement("li");
        li.textContent = text;
        symptomActionList.appendChild(li);
      });
      symptomCards.style.display = "block";
    }
    symptomSelect.addEventListener("change", renderSymptom);

    // ---------- Reminders ----------
    const REM_KEY = "whicarereminder";
    const reminderSelect = document.getElementById("reminderSelect");
    const reminderBanner = document.getElementById("reminderBanner");

    function loadReminder(){
      try{
        const obj = JSON.parse(localStorage.getItem(REM_KEY));
        return (obj && typeof obj === "object") ? obj : {};
      }catch(e){ return {}; }
    }
    function saveReminder(obj){
      localStorage.setItem(REM_KEY, JSON.stringify(obj || {}));
    }
    function updateReminderBanner(forceLastUpdate){
      let rem = loadReminder();
      if (forceLastUpdate && lastReading){
        rem.last = lastReading.when;
        saveReminder(rem);
      }
      reminderBanner.style.display = "none";
      if (!rem.days || !rem.last) return;

      let daysAgo = 0;
      try{
        const tLast = new Date(rem.last).getTime();
        if (!isNaN(tLast)){
          const now = Date.now();
          daysAgo = Math.round((now - tLast) / (1000*60*60*24));
        }
      }catch(e){ daysAgo = 0; }

      if (daysAgo >= rem.days){
        const msg = strings.reminder_due.replace("{n}", String(daysAgo));
        reminderBanner.textContent = msg;
        reminderBanner.style.display = "block";
      } else if (daysAgo >= 0){
        const msg = strings.reminder_ok.replace("{n}", String(daysAgo));
        reminderBanner.textContent = msg;
        reminderBanner.style.display = "block";
      }
    }

    const remInit = loadReminder();
    if (remInit.days){
      reminderSelect.value = String(remInit.days);
    }
    document.getElementById("saveReminder").addEventListener("click", () => {
      const days = parseInt(reminderSelect.value, 10) || 0;
      const obj = loadReminder();
      obj.days = days;
      if (lastReading) obj.last = lastReading.when;
      saveReminder(obj);
      if (days > 0){
        const msg = strings.reminder_saved.replace("{n}", String(days));
        reminderBanner.textContent = msg;
        reminderBanner.style.display = "block";
      } else {
        reminderBanner.style.display = "none";
      }
    });

    // ---------- Care library lists ----------
    function renderLibraryLists(){
      function fill(id, arr){
        const ul = document.getElementById(id);
        if (!ul) return;
        ul.innerHTML = "";
        (arr || []).forEach(text => {
          const li = document.createElement("li");
          li.textContent = text;
          ul.appendChild(li);
        });
      }
      fill("homeCareList", strings.homeCareList);
      fill("farmCareList", strings.farmCareList);
      fill("communityCareList", strings.communityCareList);
      fill("factsList", strings.factsList);
    }

    // ---------- Load latest reading button ----------
    document.getElementById("loadLast").addEventListener("click", () => {
      if (!readings.length){
        alert("No saved readings found. Go to the Measure page and save at least one reading.");
        return;
      }
      if (preselectedId != null){
        const found = readings.find(r => r.id === preselectedId);
        lastReading = found || readings[readings.length - 1];
      } else {
        lastReading = readings[readings.length - 1];
      }
      renderReading();
      updateReminderBanner(true);
    });

    if (preselectedId != null && readings.length){
      const found = readings.find(r => r.id === preselectedId);
      lastReading = found || readings[readings.length - 1];
      renderReading();
      updateReminderBanner(true);
    }

    // Initial render
    renderChecklist();
    renderLibraryLists();
    renderSymptom();
    updateReminderBanner(false);
  </script>
</body>
</html>
